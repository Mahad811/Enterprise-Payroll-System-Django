<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Employee Payroll System</title>
    <link rel="stylesheet" href="/static/css/style.css">
    {% load static %}
</head>

<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Payroll System</h2>
            </div>
            <div class="user-info">
                <div class="user-avatar">
                    <img src="{% if employee.profile_image %}{{ employee.profile_image.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}"
                        alt="User Avatar" onerror="this.onerror=null; this.src='{% static 'img/default-avatar.png' %}'">
                    <div class="avatar-upload">
                        <label for="profile-upload" class="avatar-upload-btn" title="Change profile picture">üì∑</label>
                        <input type="file" id="profile-upload" accept="image/*" style="display: none;"
                            onclick="event.stopPropagation();" onchange="uploadProfileImage(this)">
                    </div>
                </div>
                <div class="user-details">
                    <h3>{{ employee.get_full_name }}</h3>
                    <p>{{ employee.role }}</p>
                </div>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="#"><span class="icon">üìä</span> Dashboard</a></li>
                <li><a href="{% url 'payroll' %}"><span class="icon">üí∞</span> Payroll</a></li>
                {% if employee.role == "Manager" %}
                <li><a href="{% url 'salary' %}"><span class="icon">üí∞</span> Salary Management</a></li>
                {% endif %}
                {% if employee.role != "Admin" %}
                <li><a href="{% url 'leave' %}"><span class="icon">üóìÔ∏è</span> Leave Management</a></li>
                {% endif %}
                {% if employee.role == "Admin" %}
                <li><a href="{% url 'employee' %}"><span class="icon">üë•</span> Employees</a></li>
                {% endif %}
                {% if employee.role == "Admin" or employee.role == "Employee"%}
                <li><a href="{% url 'settings' %}"><span class="icon">‚öôÔ∏è</span> Settings</a></li>
                {% endif %}
                <li><a href="{% url 'logout' %}"><span class="icon">üö™</span> Logout</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <input type="text" placeholder="Search...">
                    <button type="submit">üîç</button>
                </div>
                <div class="top-bar-actions">
                    <div class="notification">
                        <span class="icon">üîî</span>
                        <span class="badge">3</span>
                    </div>
                    <div class="messages">
                        <span class="icon">‚úâÔ∏è</span>
                        <span class="badge">5</span>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <p>Welcome back, {{ employee.first_name }}!</p>
                </div>

                <div class="stats-cards">
                    <div class="card">
                        <div class="card-icon">üíµ</div>
                        <div class="card-info">
                            <h3> Base Salary</h3>
                            <p class="amount">
                                {% if most_recent_salary %}
                                ${{ most_recent_salary }}
                                {% else %}
                                $0.00
                                {% endif %}
                            </p>
                        </div>

                    </div>

                    <div class="card">
                        <div class="card-icon">üìÖ</div>
                        <div class="card-info">
                            <h3>Leave Balance</h3>
                            <p class="amount">{{ leave_balance }} days</p>
                        </div>
                    </div>



                </div>

                <div class="dashboard-grid">

                    <div class="grid-item salary-slips">
                        <div class="item-header">
                            <h2>Salary Slips</h2>
                            <a href="{% url 'payroll' %}" class="view-all">View All</a>
                        </div>
                        <div class="item-content">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Year</th>
                                        <th>Net Pay</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if payslips %}
                                    {% for payslip in payslips %}
                                    <tr>
                                        <td>{{ payslip.month }}</td>
                                        <td>{{ payslip.year }}</td>
                                        <td>${{ payslip.net_salary }}</td>
                                        <td><span class="status {{ payslip.status|lower }}">{{ payslip.status }}</span>
                                        </td>
                                        <td><a href="{% url 'payroll' %}?id={{ payslip.id }}" class="btn-small">View</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="5">No salary slips available</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>


                    <div class="grid-item announcements">
                        <div class="item-header">
                            <h2>Announcements</h2>
                        </div>
                        <div class="item-content">
                            <div class="announcement-list">
                                {% if announcements %}
                                {% for announcement in announcements %}
                                <div class="announcement">
                                    <h3>{{ announcement.title }}</h3>
                                    <p class="date">{{ announcement.date|date:"F d, Y" }}</p>
                                    <p class="description">{{ announcement.description }}</p>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="announcement">
                                    <p>No leave request updates at this time</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Image Upload Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Update Profile Picture</h2>
                <span class="close" onclick="closeProfileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="profile-avatar-section">
                    <div class="profile-avatar">
                        <img id="preview-image"
                            src="{% if employee.profile_image %}{{ employee.profile_image.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}"
                            alt="Profile Preview">
                    </div>
                    <p class="avatar-help">Preview of your new profile picture</p>
                </div>
                <form id="profile-image-form" method="post" action="{% url 'update_profile_image' %}"
                    enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="image_data" id="image-data">
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Function to handle profile image upload
        function uploadProfileImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    // Preview the image
                    document.getElementById('preview-image').src = e.target.result;

                    // Store the image data
                    document.getElementById('image-data').value = e.target.result;

                    // Show the modal
                    var modal = document.getElementById('profile-modal');
                    modal.style.display = 'block';
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        // Function to close the profile modal
        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function (event) {
            var modal = document.getElementById('profile-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Add event listener to ensure the upload button works
        document.addEventListener('DOMContentLoaded', function () {
            var uploadBtn = document.querySelector('.avatar-upload-btn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            }
        });
    </script>
</body>

</html>